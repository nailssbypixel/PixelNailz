<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script>
      let availableDates = [];

      // Fetch available/booked dates
      function fetchDates() {
        google.script.run.withSuccessHandler(data => {
          availableDates = data.available;
          populateDatePicker();
        }).doGet({action: 'fetch'});
      }

      function populateDatePicker() {
        const dateInput = document.getElementById('date');
        const today = new Date();
        dateInput.min = today.toISOString().split('T')[0];

        dateInput.addEventListener('input', function() {
          const selected = this.value;
          if (!availableDates.includes(selected)) {
            alert("This date is not available. Please select another.");
            this.value = '';
          }
        });
      }

      function bookAppointment() {
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const service = document.getElementById('service').value;
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;
        const length = document.getElementById('length').value;

        google.script.run.withSuccessHandler(response => {
          alert(response.message);
          if (response.status === 'success') {
            document.getElementById('bookingForm').reset();
            fetchDates(); // refresh available dates
          }
        }).doPost(JSON.stringify({
          action: 'book',
          name, email, phone, service, date, time, length
        }));
      }

      window.onload = fetchDates;
    </script>
  </head>
  <body>
    <h2>PixelNailz Booking</h2>
    <form id="bookingForm" onsubmit="event.preventDefault(); bookAppointment();">
      <label>Name:</label><br>
      <input type="text" id="name" required><br><br>

      <label>Email:</label><br>
      <input type="email" id="email" required><br><br>

      <label>Phone:</label><br>
      <input type="text" id="phone" required><br><br>

      <label>Service:</label><br>
      <input type="text" id="service" required><br><br>

      <label>Date:</label><br>
      <input type="date" id="date" required><br><br>

      <label>Time:</label><br>
      <input type="time" id="time" required><br><br>

      <label>Length:</label><br>
      <input type="text" id="length" value="N/A"><br><br>

      <button type="submit">Book</button>
    </form>
  </body>
</html>
