const SHEET_ID = "YOUR_SHEET_ID"; // Replace with your spreadsheet ID
const SHEET_NAME = "Bookings";
const NOTIFICATION_EMAIL = "nailssbypixel@gmail.com";

function doGet(e) {
  if(e.parameter.action === "fetch") {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    const data = sheet.getDataRange().getValues().slice(1);
    const bookings = data.map(row => ({
      date: formatDate(row[4]),
      time: row[5].toString().trim()
    }));
    return ContentService.createTextOutput(JSON.stringify({ bookings }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  return ContentService.createTextOutput("OK");
}

function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);

  if(data.action === "book") {
    // Check if date & time already booked
    const values = sheet.getDataRange().getValues().slice(1);
    const isBooked = values.some(row => formatDate(row[4]) === data.date && row[5].toString().trim() === "12:00 PM");
    if(isBooked) {
      return ContentService.createTextOutput(JSON.stringify({status:"error", message:"This date is already booked!"}))
                           .setMimeType(ContentService.MimeType.JSON);
    }

    sheet.appendRow([
      data.name || "",
      data.phone || "",
      data.service || "",
      data.length || "N/A",
      data.date || "",
      "12:00 PM",
      data.email || ""
    ]);

    // Send email
    MailApp.sendEmail(NOTIFICATION_EMAIL, `New PixelNailz Booking: ${data.name}`,
      `Name: ${data.name}\nPhone: ${data.phone}\nEmail: ${data.email}\nService: ${data.service} ${data.service === "Acrylic Full Set" ? "(" + data.length + ")" : ""}\nDate: ${data.date}\nTime: 12:00 PM`
    );

    return ContentService.createTextOutput(JSON.stringify({status:"success", message:"Booking successful!"}))
                         .setMimeType(ContentService.MimeType.JSON);

  } else if(data.action === "cancel") {
    const values = sheet.getDataRange().getValues();
    let found = false;
    for(let i = values.length-1; i>=1; i--) {
      const row = values[i];
      if(!row || row.length<7) continue;
      const rowEmail = (row[6]||"").toString().trim();
      const rowDate = formatDate(row[4]);
      const rowTime = row[5].toString().trim();
      if(rowEmail === (data.email||"").trim() && rowDate === (data.date||"").trim() && rowTime === "12:00 PM") {
        sheet.deleteRow(i+1);
        found = true;
        break;
      }
    }
    return ContentService.createTextOutput(JSON.stringify({status:"success", message: found?"Booking cancelled successfully.":"No matching booking found."}))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}

function formatDate(value){
  if(value instanceof Date) return Utilities.formatDate(value, Session.getScriptTimeZone(), "yyyy-MM-dd");
  return value.toString().trim();
}
